<!-- OpenBabel Analysis -->
<div id="openbabel-container" class="container" style="display: none;">
    <div class="controls">
        <form id="openbabel-form">
            <div class="form-group">
                <label>Input Format:</label>
                <select id="input-format" onchange="updateInputField()">
                    <option value="smiles">SMILES</option>
                    <option value="xyz">XYZ</option>
                    <option value="pdb">PDB</option>
                </select>
            </div>

            <!-- SMILES Input -->
            <div id="smiles-input">
                <div class="form-group">
                    <label>SMILES String:</label>
                    <input type="text" id="smiles-data" placeholder="e.g., CCO for ethanol">
                    <div class="examples">
                        Examples:
                        <button type="button" onclick="setExample('CCO')">Ethanol</button>
                        <button type="button" onclick="setExample('c1ccccc1')">Benzene</button>
                        <button type="button" onclick="setExample('CC(=O)O')">Acetic Acid</button>
                    </div>
                </div>
            </div>

            <!-- XYZ Input -->
            <div id="xyz-input" style="display: none;">
                <div class="form-group">
                    <label>XYZ Data:</label>
                    <textarea id="xyz-data" rows="10" placeholder="Enter XYZ coordinates..."></textarea>
                </div>
            </div>

            <!-- PDB Input -->
            <div id="pdb-input" style="display: none;">
                <div class="form-group">
                    <label>PDB Data:</label>
                    <textarea id="pdb-data" rows="10" placeholder="Enter PDB data..."></textarea>
                </div>
            </div>

            <!-- Analysis Options -->
            <div class="form-group">
                <label>Optimize Geometry:</label>
                <input type="checkbox" id="optimize-geometry">
            </div>

            <div id="optimization-params" style="display: none;">
                <div class="form-group">
                    <label>Force Field:</label>
                    <select id="force-field">
                        <option value="mmff94">MMFF94</option>
                        <option value="uff">UFF</option>
                    </select>
                    <p class="description">
                        MMFF94: Merck Molecular Force Field - Best for organic molecules and drug-like compounds<br>
                        UFF: Universal Force Field - Good for general molecules including organometallics
                    </p>
                </div>
                <div class="form-group">
                    <label>Optimization Steps:</label>
                    <input type="number" id="opt-steps" value="500" min="100" max="5000" step="100">
                    <p class="description">
                        Number of geometry optimization steps. Higher values give better geometry but take longer.<br>
                        Recommended: 500 steps for most molecules, 1000 for complex structures.
                    </p>
                </div>
            </div>

            <button type="submit">Analyze Structure</button>
        </form>
    </div>
    <div id="openbabel-plot" class="plot"></div>
</div>

<script>
function updateInputField() {
    const format = document.getElementById('input-format').value;
    
    // Hide all input sections
    document.getElementById('smiles-input').style.display = 'none';
    document.getElementById('xyz-input').style.display = 'none';
    document.getElementById('pdb-input').style.display = 'none';
    
    // Show selected input section
    if (format === 'smiles') {
        document.getElementById('smiles-input').style.display = 'block';
    } else if (format === 'xyz') {
        document.getElementById('xyz-input').style.display = 'block';
    } else if (format === 'pdb') {
        document.getElementById('pdb-input').style.display = 'block';
    }
}

function setExample(smiles) {
    document.getElementById('smiles-data').value = smiles;
}

// Toggle optimization parameters
document.getElementById('optimize-geometry').addEventListener('change', function() {
    document.getElementById('optimization-params').style.display = 
        this.checked ? 'block' : 'none';
});

document.getElementById('openbabel-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const format = document.getElementById('input-format').value;
    let data;
    
    // Get input data based on format
    if (format === 'smiles') {
        data = document.getElementById('smiles-data').value;
    } else if (format === 'xyz') {
        data = document.getElementById('xyz-data').value;
    } else if (format === 'pdb') {
        data = document.getElementById('pdb-data').value;
    }
    
    // Get optimization parameters
    const optimize = document.getElementById('optimize-geometry').checked;
    const requestData = {
        input_format: format,
        data: data,
        optimize: optimize
    };
    
    if (optimize) {
        requestData.force_field = document.getElementById('force-field').value;
        requestData.steps = parseInt(document.getElementById('opt-steps').value);
    }

    try {
        const response = await fetch('/openbabel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();
        if (result.error) {
            console.error('OpenBabel analysis error:', result.error);
            return;
        }
        
        if (result.plot) {
        const plotData = JSON.parse(result.plot);
        Plotly.newPlot('openbabel-plot', plotData.data, plotData.layout);
        }
    } catch (error) {
        console.error('Error running OpenBabel analysis:', error);
    }
});

// Initialize input field visibility
updateInputField();</script>

<style>
.examples {
    margin-top: 10px;
}

.examples button {
    margin-right: 10px;
    padding: 5px 10px;
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
}

.examples button:hover {
    background-color: #e0e0e0;
}

textarea {
    width: 100%;
    font-family: monospace;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.description {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
    margin-bottom: 15px;
    padding-left: 10px;
    border-left: 3px solid #ddd;
}
</style> 