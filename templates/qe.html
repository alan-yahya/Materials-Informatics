<!-- Quantum ESPRESSO Simulation -->
<div id="qe-container" class="container" style="display: none;">
    <div class="controls">
        <form id="qe-form">
            <div class="form-group">
                <label>Structure Type:</label>
                <select id="structure-type">
                    <option value="bulk">Bulk Crystal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Calculation Type:</label>
                <select id="calculation-type">
                    <option value="scf">SCF</option>
                </select>
            </div>
            <div class="form-group">
                <label>Plot Type:</label>
                <select id="plot-type">
                    <option value="scf">SCF Results</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lattice Constant (Ã…):</label>
                <input type="number" id="lattice-constant" value="3.5" min="2.0" max="10.0" step="0.1">
            </div>
            <div class="form-group">
                <label>K-points (x, y, z):</label>
                <input type="number" id="kpts-x" value="4" min="1" max="12" step="1">
                <input type="number" id="kpts-y" value="4" min="1" max="12" step="1">
                <input type="number" id="kpts-z" value="4" min="1" max="12" step="1">
            </div>
            <div class="form-group">
                <label>Wavefunction Cutoff (Ry):</label>
                <input type="number" id="ecutwfc" value="40" min="10" max="100" step="5">
            </div>
            <div class="form-group">
                <label>Charge Density Cutoff (Ry):</label>
                <input type="number" id="ecutrho" value="320" min="80" max="800" step="40">
            </div>
            <button type="submit">Run QE Calculation</button>
        </form>
    </div>
    <div id="qe-plot" class="plot"></div>
    
    <!-- Installation Instructions -->
    <div id="qe-install-info" class="info-box" style="display: none;">
        <h3>Quantum ESPRESSO Installation Required</h3>
        <p>Quantum ESPRESSO (pw.x) is not installed or not in your system PATH. Please follow these installation instructions:</p>
        
        <h4>Windows:</h4>
        <ol>
            <li>Download the Windows binary from <a href="http://www.qe-forge.org/gf/project/q-e/frs/" target="_blank">QE-forge</a></li>
            <li>Extract the downloaded archive</li>
            <li>Add the bin directory to your system PATH</li>
        </ol>
        
        <h4>Linux:</h4>
        <pre>sudo apt-get install quantum-espresso</pre>
        
        <h4>macOS:</h4>
        <pre>brew install quantum-espresso</pre>
        
        <p>After installation, restart your application and try again.</p>
    </div>
</div>

<script>
document.getElementById('qe-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        structure_type: document.getElementById('structure-type').value,
        calculation_type: document.getElementById('calculation-type').value,
        plot_type: document.getElementById('plot-type').value,
        lattice_constant: parseFloat(document.getElementById('lattice-constant').value),
        kpts: [
            parseInt(document.getElementById('kpts-x').value),
            parseInt(document.getElementById('kpts-y').value),
            parseInt(document.getElementById('kpts-z').value)
        ],
        ecutwfc: parseFloat(document.getElementById('ecutwfc').value),
        ecutrho: parseFloat(document.getElementById('ecutrho').value)
    };

    try {
        const response = await fetch('/qe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.error) {
            console.error('QE simulation error:', result.error);
            // Show installation instructions if QE is not installed
            if (result.error.includes('not installed')) {
                document.getElementById('qe-install-info').style.display = 'block';
            }
            return;
        }
        
        // Hide installation instructions if simulation succeeds
        document.getElementById('qe-install-info').style.display = 'none';
        
        const plotData = JSON.parse(result.plot);
        Plotly.newPlot('qe-plot', plotData.data, plotData.layout);
    } catch (error) {
        console.error('Error running QE simulation:', error);
    }
});</script>

<style>
.info-box {
    margin: 20px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.info-box h3 {
    color: #333;
    margin-top: 0;
}

.info-box h4 {
    color: #666;
    margin-top: 15px;
}

.info-box pre {
    background-color: #eee;
    padding: 10px;
    border-radius: 3px;
    overflow-x: auto;
}

.info-box a {
    color: #0066cc;
    text-decoration: none;
}

.info-box a:hover {
    text-decoration: underline;
}
</style> 